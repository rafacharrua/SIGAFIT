#include "rwmake.ch"        // incluido pelo assistente de conversao do AP5 IDE em 09/06/00

User Function Gerfasb()        // incluido pelo assistente de conversao do AP5 IDE em 09/06/00

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Declaracao de variaveis utilizadas no programa atraves da funcao    ³
//³ SetPrvt, que criara somente as variaveis definidas pelo usuario,    ³
//³ identificando as variaveis publicas do sistema utilizadas no codigo ³
//³ Incluido pelo assistente de conversao do AP5 IDE                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

SetPrvt("DULTDATA,NOP,OGERA,NTOT,DDTINI,DDTULT")
SetPrvt("NMDDOLAR,NTOTMD,NMD,CNOME,ATAXAS,ACONTAS")
SetPrvt("NCTA,NSLDINI,ATAMNUM,CPROXNUM,CNUMSZ3,CLINSZ3")
SetPrvt("DDATSZ3,CNUMSI2,NRECSI2,")

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ GERFASB  º Autor ³ Luiz Carlos Vieira º Data ³Tue  29/09/98º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDescri‡„o ³ Gera o arquivo SZ3 dos lanctos FASB a partir do SI2        º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ Espec¡fico para ESPN Brasil.                               º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºObserv.:  ³ Uso do parametro MV_FASBDT, data ultima contabilizacao FASBº±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se o parametro MV_FASBDT existe                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

dbSelectArea("SX6")
dbSetOrder(1)
If !dbSeek(xFilial("SX6")+"MV_FASBDT")

    Aviso("Aten‡„o!","O parƒmetro MV_FASBDT foi criado com a Data Base: ";
           +DTOC(dDataBase),{"Ok"})

    RecLock("SX6",.T.)
    SX6->X6_FIL     := xFilial("SX6")
    SX6->X6_VAR     := "MV_FASBDT"
    SX6->X6_TIPO    := "D"
    SX6->X6_DESCRIC := "Data da £ltima contabiliza‡„o FASB."
    SX6->X6_CONTEUD := DTOC(dDataBase)
    MsUnLock()
Endif
dbSelectArea("SI2")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Variaveis do programa                                               ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

dUltData := GetMv("MV_FASBDT")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Se o mes e o ano da data base forem menores do que dUltData, erro!  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

If ( Year(dDataBase) < Year(dUltData) ) .Or. ;
   ( Year(dDataBase) == Year(dUltData) .And. ;
     Month(dDataBase) < Month(dUltData)        )

    Aviso("Erro!","A Data Base do sistema est  menor do que o conte£do do parƒmetro MV_FASBDT: ";
           +DTOC(dUltData),{"Ok"})

    Return

Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Tela de confirmacao do processamento                                ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

#IFNDEF WINDOWS
    DrawAdvWindow("Contabiliza‡„o FASB Off-Line",04,06,17,73)
    @05,07 Say "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿" Color "B/BG"
    @06,07 Say "³                                                                ³" Color "B/BG"
    @07,07 Say "³                                                                ³" Color "B/BG"
    @08,07 Say "³ Este programa tem como objetivo gerar o arquivo SZ3 com os lan ³" Color "B/BG"
    @09,07 Say "³ ‡amentos cont beis FASB, a partir da amarra‡„o FASB-SIGA (SZ1) ³" Color "B/BG"
    @10,07 Say "³ e do arquivo de lan‡amentos cont beis do Siga Advanced (SI2).  ³" Color "B/BG"
    @11,07 Say "³ Os c lculos s„o efetuados de acordo com o tipo das contas FASB ³" Color "B/BG"
    @12,07 Say "³ Monet rias, Hist¢ricas ou de Resultado.                        ³" Color "B/BG"
    @13,07 Say "³                                                                ³" Color "B/BG"
    @14,07 Say "³                                                                ³" Color "B/BG"
    @15,07 Say "³                                                                ³" Color "B/BG"
    @16,07 Say "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ" Color "B/BG"

    @06,09 Say "Data da £ltima contabiliza‡„o FASB: "+DTOC(dUltData)                Color "W+/BG"
    @14,09 Say "Aten‡„o:  O reprocessamento desta rotina dentro do mesmo per¡o"     Color "W+/BG"
    @15,09 Say "do (ano e mes), sobrescreve os lan‡amentos j  existentes.     "     Color "W+/BG"

    While .T.
        nOp := MenuH({"Confirma","Abandona"},17,07,"b/w,w+/n,r/w","CA","Quanto ao Processamento?",1)
        Do Case
        Case nOp == 1 // Confirma
            RunProc()
            Exit
        Case nOp == 2 .Or. nOp == 0 // Abandona
            Exit
        EndCase
    EndDo
#ELSE
    oGera := NIL
    @ 107,064 To 355,706 Dialog oGera Title "Contabiliza‡„o FASB Off-Line"

    @ 001,001 To 016,320
    @ 007,004 Say OemToAnsi("Data da £ltima contabiliza‡„o FASB: "+DTOC(dUltData)) Size 200,07

    @ 018,001 To 122,320

    @ 027,004 Say OemToAnsi("Este programa tem como objetivo gerar o arquivo SZ3 com os lan‡amentos cont beis FASB, a partir da amarra‡„o")
    @ 038,004 Say OemToAnsi("FASB - SIGA (SZ1) e do arquivo de lan‡amentos cont beis do Siga Advanced (SI2). Os c lculos s„o efetuados de")
    @ 049,004 Say OemToAnsi("acordo com o tipo das contas FASB Monet rias, Hist¢ricas ou de Resultado.                                   ")
    @ 093,004 Say OemToAnsi("Aten‡„o:  O reprocessamento desta rotina dentro do mesmo per¡odo (ano e mes), sobrescreve os lan‡amentos j  ")
    @ 104,004 Say OemToAnsi("existentes.")

    @ 089,290 BmpButton Type 1 Action RunProc()// Substituido pelo assistente de conversao do AP5 IDE em 09/06/00 ==>     @ 089,290 BmpButton Type 1 Action Execute(RunProc)
    @ 105,290 BmpButton Type 2 Action Close(oGera)
    Activate Dialog oGera

#ENDIF

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºFun‡„o    ³ RUNPROC  º Autor ³ Luiz Carlos Vieira º Data ³Tue  29/09/98º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDescri‡„o ³ Rotina para continuacao do processamento                   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ Espec¡fico para ESPN Brasil.                               º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

// Substituido pelo assistente de conversao do AP5 IDE em 09/06/00 ==> Function RunProc
Static Function RunProc()

dbSelectArea("SZ3")
nTot := RecCount()
dbSelectArea("SI2")
nTot := nTot + RecCount()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Regua de processamento                                              ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

#IFDEF WINDOWS
    Processa({|| StatFunc()},"Contabiliza‡„o")// Substituido pelo assistente de conversao do AP5 IDE em 09/06/00 ==>     Processa({|| Execute(StatFunc)},"Contabiliza‡„o")
    Return
// Substituido pelo assistente de conversao do AP5 IDE em 09/06/00 ==>     Function StatFunc
Static Function StatFunc()
    ProcRegua(nTot)
#ELSE
    SetRegua(nTot)
#ENDIF

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Data inicial e data final para o processamento, obtida no mes atual ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

dDtIni := CTOD("01"+Substr(DTOC(dUltData),3))
dDtUlt := dUltData
While Month(dDtUlt) == Month(dUltData) .And. ;
      Year(dDtUlt)  == Year(dUltData)

    dDtUlt := dDtUlt + 1

EndDo
dDtUlt := dDtUlt - 1

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Processamento parte 1 - Deleta os registros do SZ3 do periodo que possam ³
//³ existir.                                                                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

dbSelectArea("SZ3")
dbSetOrder(1)
dbSeek(xFilial("SZ3")+DTOS(dDtIni),.T.)
While !EOF() .And. xFilial("SZ3") == SZ3->Z3_FILIAL .And. ;
      SZ3->Z3_DATA <= dDtUlt

    #IFNDEF WINDOWS
        IncRegua()
    #ELSE
        IncProc("Limpando lan‡amentos existentes...")
    #ENDIF

    RecLock("SZ3",.F.)
    dbDelete()
    MsUnLock()
    dbSelectArea("SX2")
    dbSeek("SZ3")
    RecLock("SX2",.F.)
    SX2->X2_DELET := SX2->X2_DELET + 1
    MsUnLock()
    dbSelectArea("SZ3")

    dbSkip()

EndDo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Processamento parte 2 - Obtencao das taxas para calculos em aTaxas: ³
//³ 1. Taxa final do mes anterior                                       ³
//³ 2. Taxa media do mes corrente                                       ³
//³ 3. Taxa final do mes corrente                                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

nMdDolar   := 1
nTotMd     := ContaMoedas()
For nMd    := 1 To nTotMd
    cNome  := GetMv("MV_MOEDA"+StrZero(nMd,1))
    If "DOLAR" $ UPPER(cNome)
        nMdDolar := nMd
    Endif
Next nMd

aTaxas     := {0,0,0}
aTaxas[1]  := RecMoeda(dDtIni-1 , StrZero(nMdDolar,1))
aTaxas[2]  := Media(nMdDolar                         )
aTaxas[3]  := RecMoeda(dDtUlt   , StrZero(nMdDolar,1))

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Processamento parte 2 - Gera lancamentos a partir do SI2            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

dbSelectArea("SI2")
dbSetOrder(3)        // FILIAL+DATA+NUM+LINHA
dbSeek(xFilial("SI2")+DTOS(dDtIni),.T.)

While !EOF() .And. xFilial("SI2") == SI2->I2_FILIAL .And. ;
      SI2->I2_DATA <= dDtUlt

    #IFNDEF WINDOWS
        IncRegua()
    #ELSE
        IncProc("Gerando lan‡amentos FASB...")
    #ENDIF

    //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
    //³ Localizando as contas no SZ2, pode saber em que conta FASB pertence ³
    //³ e acumular no SZ3 os valores pela data de acordo com o tipo do lan- ³
    //³ camento (DEBITO ou CREDITO)                                         ³
    //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

    aContas := {}
    If SI2->I2_DC == "D"
        aAdd(aContas , {SI2->I2_DEBITO  ,"D"})
    ElseIf SI2->I2_DC == "C"
        aAdd(aContas , {SI2->I2_CREDITO ,"C"})
    ElseIf SI2->I2_DC == "X"
        aAdd(aContas , {SI2->I2_DEBITO  ,"D"})
        aAdd(aContas , {SI2->I2_CREDITO ,"C"})
    Endif

    For nCta := 1 To Len(aContas)

        //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
        //³ Se determinada conta pertencer a mais de uma conta FASB, processa todas  ³
        //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

        dbSelectArea("SZ2")
        dbSetOrder(2)
        dbSeek(xFilial("SZ2")+aContas[nCta,1])
        While !EOF() .And. xFilial("SZ2") == SZ2->Z2_FILIAL .And. ;
              SZ2->Z2_CONTA == aContas[nCta,1]

            //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
            //³ Pesquisa a conta FASB no SZ1                                        ³
            //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

            dbSelectArea("SZ1")
            dbSetOrder(1)
            dbSeek(xFilial("SZ1")+SZ2->Z2_CODIGO)

            //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
            //³ Variavel para o saldo inicial da movimentecao da conta FASB         ³
            //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

            nSldIni := 0

            //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
            //³ Pesquisa no SZ3 pela conta FASB na mesma data do lancto do SI2      ³
            //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

            dbSelectArea("SZ3")
            dbSetOrder(1)
            If !dbSeek(xFilial("SZ3")+DTOS(SI2->I2_DATA)+SZ1->Z1_CODIGO)

                //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
                //³ Calcula o saldo inicial para a conta FASB encontrada                ³
                //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

                CalcSldIni()

                //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
                //³ Obtencao do proximo numero do movimento                             ³
                //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
                aTamNum  := TamSx3("Z3_NUM")
                dbSelectArea("SX3")
                dbSetOrder(2)
                dbSeek("Z3_NUM")
                dbSelectArea("SZ3")
                cProxNum := ProxReg(1,aTamNum[1],2)

                RecLock("SZ3",.T.)
                SZ3->Z3_FILIAL := xFilial("SZ3")
                SZ3->Z3_DATA   := SI2->I2_DATA
                SZ3->Z3_CODIGO := SZ1->Z1_CODIGO
                SZ3->Z3_NUM    := cProxNum
                SZ3->Z3_LINHA  := "01"
            Else
                RecLock("SZ3",.F.)
            Endif

            //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
            //³ Calculo da movimentacao. Para todas as contas o movimento e dividido³
            //³ pela taxa media do mes.                                             ³
            //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

            If aContas[nCta,2] == "D"
                SZ3->Z3_VALOR  := nSldIni + SZ3->Z3_VALOR + NoRound(SI2->I2_VALOR / If(aTaxas[2]<=0,1,aTaxas[2]) ,2)
            Else
                SZ3->Z3_VALOR  := nSldIni + SZ3->Z3_VALOR - NoRound(SI2->I2_VALOR / If(aTaxas[2]<=0,1,aTaxas[2]) ,2)
            Endif
            SZ3->Z3_HP         := SI2->I2_HP
            SZ3->Z3_HIST       := SI2->I2_HIST

            MsUnLock()

            //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
            //³ Caso existem lanctos no SI2 com DC = "-", leva os historicos p/ o SZ3 ³
            //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

            cNumSZ3 := SZ3->Z3_NUM
            cLinSZ3 := StrZero(Val(SZ3->Z3_LINHA)+1,2)
            dDatSZ3 := SZ3->Z3_DATA
            cNumSI2 := SI2->I2_NUM

            dbSelectArea("SI2")
            nRecSI2 := Recno()

            While !EOF() .And. xFilial("SI2") == SI2->I2_FILIAL .And. ;
                  SI2->I2_NUM == cNumSI2 .And. SI2->I2_DATA == dDatSZ3 .And. ;
                  SI2->I2_DC == "-"

                dbSelectArea("SZ3")
                RecLock("SZ3",.T.)
                SZ3->Z3_FILIAL := xFilial("SZ3")
                SZ3->Z3_DATA   := SI2->I2_DATA
                SZ3->Z3_CODIGO := SZ1->Z1_CODIGO
                SZ3->Z3_NUM    := cNumSZ3
                SZ3->Z3_LINHA  := cLinSZ3
                SZ3->Z3_HP     := SI2->I2_HP
                SZ3->Z3_HIST   := SI2->I2_HIST
                MsUnLock()

                cLinSZ3        := StrZero(Val(cLinSZ3)+1,2)

                dbSelectArea("SI2")
                dbSkip()
            EndDo

            dbGoTo(nRecSI2)

            dbSelectArea("SZ2")
            dbSkip()
        EndDo
    Next nCta

    dbSelectArea("SI2")
    dbSkip()
EndDo

dbSelectArea("SZ3")
RetIndex("SZ3")
dbSelectArea("SZ1")

#IFDEF WINDOWS
    Close(oGera)
#ENDIF

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºFun‡„o    ³CALCSLDINIº Autor ³ Luiz Carlos Vieira º Data ³Mon  05/10/98º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDescri‡„o ³ Calcula o saldo inicial da conta FASB                      º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso		 ³ Espec¡fico para clientes Microsiga						  º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

// Substituido pelo assistente de conversao do AP5 IDE em 09/06/00 ==> Function CalcSldIni
Static Function CalcSldIni()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Variaveis                                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

nSldIni   := 0

Do Case

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Para as contas monetarias, o saldo inicial deve ser dividido pela taxa final³
//³ do mes anterior.                                                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

Case SZ1->Z1_CLASSE == "M" // Monetarias

    nSldIni := NoRound(SZ1->Z1_SALANT / aTaxas[1] , 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Para as contas historicas, o saldo inicial e exatamente o mesmo do mes anterior ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

Case SZ1->Z1_CLASSE == "H" // Historicas

    nSldIni := SZ1->Z1_SALANT

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Para as contas de resultado o saldo inicial e divido pelo dolar medio do mes ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

Case SZ1->Z1_CLASSE == "R" // Resultado

    nSldIni := NoRound(SZ1->Z1_SALANT / aTaxas[2] , 2)

EndCase

Return
